---
title: "Exploratory Data Analysis"
author: "Jin Young Kim"
date: "Thursday, April 16, 2015"
output:
  html_document:
    keep_md: true
    toc: true
    toc_depth: 2
---

# Prepare the environment
## Packages
```{r, message=FALSE}
source("c:/src/root/dbook/dbook.R")
check.and.install.packages("dplyr")
check.and.install.packages("ggplot2")
check.and.install.packages("tidyr")
check.and.install.packages("ellipse")
library(ggplot2)
library(dplyr)
library(ellipse)
library(tidyr)
library(DT)
library(knitr)
```

## Read Data

```{r, message=F}
mpg = select(mpg, maker = manufacturer, class, model, year, displ, cyl, drv, cty, hwy)
kable(head(mpg))
```

# Exploratory Analysis
## Questions

* Q1: What are the factors that affects the mpg most in general?

* Q2: Which maker / model has the best fuel efficiecy in general?

* Q3: Has the mpg technology improved over the years?

## Summary statistics

```{r}
summary(mpg)
str(mpg)
```


## Let's look at some data

```{r}
datatable(mpg, rownames=FALSE)
```


## Distribution of Individual Attributes

* Histogram & dot plot reveals more fine-grained trends

```{r, fig.width=10}
a = ggplot(mpg, aes(hwy)) 
p1 = a + geom_density()
p2 = a + geom_histogram()
p3 = a + geom_dotplot()
multiplot(p1, p2, p3, cols=3)
```


## Overall relationship between attributes

```{r, fig.width = 7, fig.height = 7}
mpg.num = select(mpg, displ, year, cyl, cty, hwy)
ctab = round(cor(mpg.num), 3)
kable(ctab)

plot(mpg.num)
```

```{r, fig.width=5, fig.height=5}
par(mfrow=c(1,1))
colorfun <- colorRamp(c("#CC0000","white","#3366CC"), space="Lab")
plotcorr(ctab, col=rgb(colorfun((ctab+1)/2), maxColorValue=255),
         mar = c(0.1, 0.1, 0.1, 0.1))
```

## Relationship between Two Attributes

### Categorical vs. Categorical Attribute

cyl ~ drv

```{r}
kable(table(mpg$cyl, mpg$drv))

par(mfrow=c(1,1))
mosaicplot(table(mpg$drv, mpg$cyl), cex=1.2, main="")
```

### Categorical vs. Numerical Attribute


Cylindar ~ MPG

```{r, fig.width=10}
par(mfrow=c(1,2))
plot(jitter(mpg$cyl), mpg$hwy, xlab="Year", ylab="MPG(hwy)")
boxplot(hwy ~ cyl, filter(mpg, cyl != 5), xlab="Year", ylab="MPG(hwy)")
```

Hwy ~ Class

```{r}
par(mfrow=c(1,1))
mpg$class = with(mpg, reorder(class, hwy, mean))
boxplot(hwy ~ class, mpg, varwidth = T)
```

Year ~ MPG

```{r, fig.width=10}
par(mfrow=c(1,2))
boxplot(hwy ~ year, mpg, xlab="Year", ylab="MPG(hwy)")
plot(jitter(mpg$year), mpg$hwy, xlab="Year", ylab="MPG(hwy)")
```


### Numerical vs. Numerical Attribute

How does hwy & cty mpg related?
How does displ & cty mpg related?

```{r,fig.height=5, fig.width=10}
par(mfrow=c(1,2))
plot(mpg.num$cty, mpg.num$hwy, xlab = "cty", ylab = "hwy", main = "Cor(cty,hwy)=0.956")
plot(mpg.num$disp, mpg.num$hwy, xlab = "displ", ylab = "hwy", main = "Cor(displ,hwy)=-0.766")
```

Adding trend line using ggplot

```{r, fig.width=10}
p1 = ggplot(mpg, aes(hwy, cty)) + geom_point() +geom_smooth()
p2 = ggplot(mpg, aes(displ, cty)) + geom_point() +geom_smooth()
multiplot(p2,p1, cols=2)
```

## Relationship between Multiple Attributes

### What are cylindar & engine related?

```{r}
ggplot(mpg, aes(hwy, cty)) + geom_point(aes(color = cyl, size = displ))
```

### MPG per Maker / Model 

```{r}
majors = group_by(mpg, maker) %>% 
	summarize(count=n()) %>% 
	filter(count > 10)
mpg.majors = filter(mpg, maker %in% majors$maker) %>% 
	distinct(model)

plot.models = ggplot(mpg.majors, aes(hwy, cty)) + 
	geom_text(aes(label = model, color = maker), size = 4, position=position_jitter(width=1, height=2))
plot.models
plot.models.zoom = plot.models + coord_cartesian(xlim=c(15,30), ylim=c(10,25))
plot.models.zoom
```

## Did MPG improve over the years?

```{r}
mpg1 = filter(mpg, year == 1999)
mpg2 = filter(mpg, year == 2008)
mpg12 = merge(mpg1, mpg2, by=c("model", "displ", "drv", "trans", "cyl" ,"fl"))
select(mpg12, model, displ, drv, trans, cyl, fl, year.x, hwy.x, year.y, hwy.y)
mpg12n = rbind(transmute(mpg12, year = year.x, hwy = hwy.x), transmute(mpg12, year = year.y, hwy = hwy.y))
t.test(mpg12$cty.x, mpg12$cty.y, paired=T)
t.test(mpg12$hwy.x, mpg12$hwy.y, paired=T)
```

```{r}
p1 = qplot(factor(year), hwy , data = mpg12n, geom = "boxplot") + geom_jitter() + labs(x="year", y="hwy")
p2 = ggplot() + geom_segment(data = mpg12, aes(x=1999, xend=2008, y=hwy.x, yend=hwy.y)) + 
	geom_point(data = mpg12, aes(x=1999, y=hwy.x), size=4, shape=21, fill="white") +
	geom_point(data = mpg12, aes(x=2008, y=hwy.y), size=4, shape=21, fill="white") +
	labs(x="year", y="hwy")
multiplot(p1, p2, cols = 2)
```

